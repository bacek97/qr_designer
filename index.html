<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Генератор QR-кода + Редактирование модулей + Валидность</title>
    <style></style>

    <script type="module">
      // import QRCode from "https://cdn.jsdelivr.net/npm/qrcode@1.5.3/+esm";
      // import UPNG from "https://cdn.jsdelivr.net/npm/upng-js@2.1.0/+esm";
      // import jsQR from "https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js/+esm";

      import encodeQR from "https://cdn.jsdelivr.net/npm/@paulmillr/qr@0.3.0/+esm";
      // import encodeQR from 'https://esm.sh/@paulmillr/qr@0.3.0';
      // import decodeQR from 'https://esm.sh/@paulmillr/qr@0.3.0/decode.js';
      // import { Bitmap } from 'https://esm.sh/@paulmillr/qr@0.3.0';

      // const bmBits = encodeQR('Hello world', 'raw', { scale: 1, ecc: 'low' });
      // const bm = new Bitmap({ width: bmBits[0].length, height: bmBits.length });
      // bm.data = bmBits;
      // console.log(bm.toImage());

      function buildQRSVG(rawBits) {
        const n = rawBits.length;
        // const svg = document.createElementNS(xmlns, 'svg');
        const svg = document.querySelector("#render");
        const xmlns = svg.getAttribute("xmlns:svg");
        const g = document.createElementNS(xmlns, "g");
        g.setAttribute("id", "render-group");

        // const colors=[...document.querySelectorAll('#colors rect')].map(r => `#${r.id}`);
        const colors = [window.ruleB.fill, window.ruleF.fill];
        for (let y = 0; y < n; y++) {
          for (let x = 0; x < n; x++) {
            const g2 = document.createElementNS(xmlns, "g");
            g2.setAttribute("class", rawBits[y][x] ? "f" : "b");
            const use = document.createElementNS(xmlns, "use");
            use.setAttribute("href", "#TRBL");
            use.setAttribute("x", x);
            use.setAttribute("y", y);
            use.setAttribute("fill", rawBits[y][x] ? colors[1] : colors[0]);
            use.addEventListener("click", () => onclk(use));
            g2.appendChild(use);
            g.appendChild(g2);
          }
        }
        // g.innerHTML = buf;
        document.querySelector("#render-group").replaceWith(g);
        svg.setAttribute("viewBox", `0 0 ${n} ${n}`);

        return svg;
      }

      function getRotatedViewBox(size, angleDeg) {
        const s = size;
        const diag = Math.ceil(s * Math.sqrt(2)); // 30
        const halfDaiag = diag / 2; // 15
        const table = [
          [0, 0], // 0°   → 0 0 21 21
          [-halfDaiag, 0], // 45°  → -15 0 30 30
          [-s, 0], // 90°  → -21 0 21 21
          [-diag, -halfDaiag], // 135° → -30 -15 30 30
          [-s, -s], // 180° → -21 -21 21 21
          [-halfDaiag, -diag], // 225° → -15 -30 30 30
          [0, -s], // 270° → 0 -21 21 21
          [0, -halfDaiag], // 315° → 0 -15 30 30
        ];
        // const a = ((angleDeg % 360) + 360) % 360;
        const k = Math.floor(angleDeg / 45) % 8;
        const [vx, vy] = table[k];
        const boxSize = k % 2 === 0 ? s : diag;
        return `${Math.floor(vx)} ${Math.floor(vy)} ${boxSize} ${boxSize}`;
      }

      function regenQR() {
        // const opts = { scale: 1, ecc: 'high' };
        // const rawBits = encodeQR('mailto:ivan@example.com?subject=Hi&body=Hello', 'raw', opts);
        const rawBits = encodeQR(textURL.value, "raw", {
          scale: 1,
          border: 0,
          ecc: ecc.value,
        });
        let sssvg = buildQRSVG(rawBits);
      }

      window.regenQR = regenQR;

      function regenURL() {
        let activeTab = document.querySelector('.activeTab').innerHTML;
        if (activeTab === 'WhatsApp') {
          let phoneNumber = phone.querySelector('input').value;
          phoneNumber.replace('+', '');
          let text = body.querySelector('textarea').value;
          text = prettyEncode(text);
          let url = `https://wa.me/${phoneNumber}?text=${text}`;
          document.querySelector('#textURL').value = url;
        }
      }
      window.regenURL = regenURL;


      function prettyEncode(str) {
        return String(str).replace( /[%&+#?/ ]/g, char => ({
            '%': '%25',
            '?': '%3F',
            '&': '%26',
            '#': '%23',
            '+': '%2B',
            ' ': '+'
        }[char]) );
      };

      function rotate(deg) {
        document.querySelector("#render-group").style.transition =
          "transform 0.5s linear";
        document.querySelector("#render-group").style.transform =
          `rotate(${deg}deg)`;

        const svg = document.querySelector("#render");
        // svg.setAttribute('viewBox', getRotatedViewBox(21, deg));
        const [x, y, w, h] = getRotatedViewBox(21, deg).split(" ");
        // console.log({ x: 50, y: 50, w: 100, h: 100 });

        animateViewBox(svg, { x, y, w, h }, 500);
      }

      window.rotate = rotate;

      function animateViewBox(svg, to, duration = 500) {
        function getViewBox(svg) {
          const vb = svg
            .getAttribute("viewBox")
            .trim()
            .split(/\s+/)
            .map(Number);
          return { x: vb[0], y: vb[1], w: vb[2], h: vb[3] };
        }
        const from = getViewBox(svg);
        const start = performance.now();
        function frame(t) {
          const k = Math.min((t - start) / duration, 1);
          const x = from.x + (to.x - from.x) * k;
          const y = from.y + (to.y - from.y) * k;
          const w = from.w + (to.w - from.w) * k;
          const h = from.h + (to.h - from.h) * k;
          svg.setAttribute("viewBox", `${x} ${y} ${w} ${h}`);
          if (k < 1) requestAnimationFrame(frame);
        }
        requestAnimationFrame(frame);
      }

      /**
       * @param {[number, number, number, number?]} color1 RGBA
       * @param {[number, number, number, number?]} color2 RGBA
       * @returns {number} Контраст по формуле WCAG
       */
      function contrastRatio(color1, color2) {
        function relLum(rgba) {
          const [r8, g8, b8] = rgba.match(/\d+/g).map(Number);

          function chan(v) {
            const s = v / 255;
            return s <= 0.03928
              ? s / 12.92
              : Math.pow((s + 0.055) / 1.055, 2.4);
          }

          const R = chan(r8);
          const G = chan(g8);
          const B = chan(b8);

          return 0.2126 * R + 0.7152 * G + 0.0722 * B;
        }

        const l1 = relLum(color1);
        const l2 = relLum(color2);

        const L_light = Math.max(l1, l2);
        const L_dark = Math.min(l1, l2);

        const ratio = (L_light + 0.05) / (L_dark + 0.05);

        const rounded = Math.round(ratio * 10) / 10;
        let r = rounded.toFixed(1).replace(/\.0$/, "");
        let txt = l1 > l2 ? "1:" + r : r + ":1";

        contrast.innerHTML = txt;

        if (+r < 3) {
          contrast.setAttribute("fill", "red");
        } else if (+r < 5) {
          contrast.setAttribute("fill", "orange");
        } else {
          contrast.setAttribute("fill", "black");
        }

        return txt;
      }
      window.contrastRatio = contrastRatio;
    </script>
  </head>
  <body>
    <div style="display: flex; flex-wrap: wrap; gap: 2rem;">
      <div style="width: 700px">
        <div style="display: flex">
          <div style="width: 700px; height: 30px" class="ie 2006">
            <style>
                            .ie.\32 006 { background: url(windowsxp.svg) no-repeat 0px -140px / auto; }
                            .ie.border { border-style: solid;
                  border-width: 50px;
                  border-image: linear-gradient(to right, #3262bd 0%, #3262bd 25%, #84b0df 25%, #84b0df 50%, #5e89cb 50%, #5e89cb 75%, #254394 75%, #254394 100%) 1 100% 0 0 fill;
              } }
                            /*.logo.\32 006:hover { background-position: 0px -87px; }*/
                            /*.ahover.\32 006:hover { background: url(windowsxp.svg) no-repeat 0px -116px / 100% 500% }*/
                            /*.logo.\32 006 { background: url(https://i.logos-download.com/113818/28926-ccc6931322fd89aa211fdc698cb3cfae.svg/Windows_Live_Search_Logo.svg) no-repeat 0px 0px / cover; }*/
                            /*.logo.\31 995 { background: url(https://iconape.com/wp-content/files/wm/352809/svg/352809.svg) no-repeat 0px 0px / contain; }*/
            </style>
          </div>
          <div style="min-width: 40px; height: 30px" class="ie2 2006">
            <style>
              .ie2.\32 006 {
                background: url(windowsxp.svg) no-repeat 100% -140px / auto;
              }
              /*.logo.\32 006:hover { background-position: 0px -87px; }*/
              /*.ahover.\32 006:hover { background: url(windowsxp.svg) no-repeat 0px -116px / 100% 500% }*/
              /*.logo.\32 006 { background: url(https://i.logos-download.com/113818/28926-ccc6931322fd89aa211fdc698cb3cfae.svg/Windows_Live_Search_Logo.svg) no-repeat 0px 0px / cover; }*/
              /*.logo.\31 995 { background: url(https://iconape.com/wp-content/files/wm/352809/svg/352809.svg) no-repeat 0px 0px / contain; }*/
            </style>
          </div>
        </div>
        <div style="border: solid 4px silver">
          <div style="display: flex">
            <nav>
              <a onclick="applyAttribs(this);">Text</a>
              <a onclick="applyAttribs(this);" class="activeTab">WhatsApp</a>
              <a onclick="applyAttribs(this);">Telegram</a>
              <a onclick="applyAttribs(this);">SMS</a>
              <a onclick="applyAttribs(this);">E-Mail</a>
              <a onclick="applyAttribs(this);">Geo</a>
              <a onclick="applyAttribs(this);">☏</a>
            </nav>
            <script>
              let attribs = { phone: {
                                label: { style: { default: 'display: none', 'WhatsApp': '', 'Telegram': '', 'SMS': '', '☏': ''} }, 
                                input: { 
                                  placeholder: { default: '+77123456789', 'WhatsApp': '77123456789' },
                                },
                              },
                              mailto: {
                                label: { style: { default: 'display: none', 'E-Mail': '' } },
                              },
                              subject: {
                                label: { style: { default: 'display: none', 'E-Mail': '' } },
                              },
                              body: {
                                label: { style: { default: 'display: none', 'WhatsApp': '', 'SMS': '', 'E-Mail': '', 'Telegram': '' } },
                                textarea: { 
                                  disabled: { default: false, 'Telegram': true },
                                },
                              },
                              geo: {
                                label: { style: { default: 'display: none', 'Geo': '' } },
                              },
                              labelText: {
                                label: { style: { default: 'display: none', 'Text': '' } },
                              },
                            };

              // function applyAttribs(container, attribs, activeTab) {
              function applyAttribs(newActive) {
                let oldActive = document.querySelector('.activeTab');
                oldActive.classList.toggle('activeTab');
                newActive.classList.toggle('activeTab');
                const activeTab = newActive.innerHTML;

                const container = coon;

                Object.keys(attribs).forEach(id => {
                  const cont = container.querySelector(`#${id}`);
                  if (!cont) return;

                  Object.keys(attribs[id]).forEach(tag => {
                    const cfg = attribs[id][tag];
                    const el = (tag === 'label') ? cont : cont.querySelector(`${tag}`);
                    console.log(el)

                    Object.keys(cfg).forEach(attr => {
                      const val = cfg[attr][activeTab] ?? cfg[attr].default;
                      if (attr === 'style') {
                        el.setAttribute('style', val ?? '');
                      } else if (attr === 'text') {
                        el.textContent = val ?? '';
                      }
                      if (attr in el) {
                        el[attr] = val;
                        console.log(attr, val)
                      } else {
                        el.setAttribute(attr, val);
                      }
                    });

                  });

                });
              }
            </script>
             <select id="ecc" onchange="regenQR()">
              <option value="low">Избыточность 7%</option>
              <option value="medium">Избыточность 15%</option>
              <option value="quartile">Избыточность 25%</option>
              <option value="high">Избыточность 30%</option>
            </select>
            <div class="logoE"></div>
          </div>
          <div>
            <span>URL:</span>
            <input
              id="textURL"
              placeholder="https://yahoo.net/"
            />
            <button
              onclick="navigator.clipboard.writeText(textURL.value)"
            >Copy</button>
            <button
              onclick="regenQR()"
            >Go</button>
          </div>
          <hr />
          <!-- <h1>URL Generator & QR Designer</h1> -->
          <div id="coon">
            <label id="labelText" style="display: none;"><span>Текст</span>
              <input
                id="text"
                value="asd"
                placeholder="geo:40.71872,-73.98905,100"
              />
            </label>
            <label id="mailto" style="display: none;" ><span>Кому</span> <input onchange="regenURL()" /><br /></label>
            <label id="subject" style="display: none;" ><span>Тема письма</span> <input onchange="regenURL()" placeholder="" /><br /></label>
            <label id="phone" ><span>Телефон</span> <input onchange="regenURL()" /><br /></label>
            <label id="body" ><span>Текст сообщения</span><br /> <textarea onchange="regenURL()"></textarea><br /></label>
            <label id="geo" style="display: none;">
                <span>Гео-координаты</span><br />
                <input id="coords" 
                       inputmode="decimal"
                       onchange="regenURL()"
                       placeholder="37.617300,55.755800"
                       style="width:100%; padding:8px; box-sizing:border-box; font-family:monospace;">
                <div id="map" style="width:400px; height:400px; border:2px solid #333; margin-top:10px;"></div>
            </label>
          </div>
          <!-- </fieldset> -->
          <script type="module">
            function toHome() {
              if ('geolocation' in navigator) {
                navigator.geolocation.getCurrentPosition(
                  position => {
                    const latlng = [position.coords.longitude, position.coords.latitude];
                    // placeMarker(L.latLng(latlng));
                    coords.value = latlng.join(',');
                    coords.dispatchEvent(new Event('change'));
                  },
                  error => {
                    console.log('Геолокация недоступна:', error.message);
                    // Запасной вариант — Москва
                    // map.setView([55.7558, 37.6173], 10);
                  },
                  { timeout: 10000 }
                );
              }
            }
            import L from 'https://cdn.jsdelivr.net/npm/leaflet@1.9.4/+esm';

            // Подключаем CSS Leaflet
            const link = document.createElement('link');
            link.rel = 'stylesheet';
            link.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
            document.head.appendChild(link);

            link.onload = () => {
              const map = L.map('map').setView([55.7558, 37.6173], 12);

              const HomeControl = L.Control.extend({
                options: { position: 'topright' },

                onAdd: function(map) {
                  const btn = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom');

                  btn.style.backgroundColor = 'white';
                  btn.style.backgroundImage = 'url("data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 24 24\' fill=\'%23333\' width=\'18px\' height=\'18px\'%3E%3Cpath d=\'M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z\'/%3E%3C/svg%3E")';
                  btn.style.backgroundRepeat = 'no-repeat';
                  btn.style.backgroundPosition = 'center';
                  btn.style.width = '30px';
                  btn.style.height = '30px';
                  btn.style.lineHeight = '30px';
                  btn.style.cursor = 'pointer';
                  btn.title = 'Домой';

                  btn.onclick = function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    if (typeof toHome === 'function') {
                      toHome();
                    }
                  };

                  return btn;
                }
              });

              // Добавляем контрол на карту
              new HomeControl().addTo(map);

              L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors',
                maxZoom: 19
              }).addTo(map);

              let marker = null;
              const input = document.getElementById('coords');

              // Функция установки/перемещения маркера
              function placeMarker(lng, lat) {
                const latlng = [lat, lng];
                if (marker) {
                  marker.setLatLng(latlng);
                } else {
                  marker = L.marker(latlng).addTo(map);
                }
                map.setView(latlng, 15);
              }

              // Клик по карте → обновляем поле и маркер
              map.on('click', e => {
                const lat = e.latlng.lat.toFixed(6);
                const lng = e.latlng.lng.toFixed(6);
                input.value = `${lng},${lat}`;
                placeMarker(lng, lat);
              });

              // Ручное изменение поля → ставим маркер
              input.addEventListener('change', () => {
                const val = input.value.trim();
                const regex = /^(-?\d+\.?\d*)\s*,\s*(-?\d+\.?\d*)$/;
                const match = val.match(regex);

                if (match) {
                  const lng = parseFloat(match[1]);
                  const lat = parseFloat(match[2]);
                  if (lat >= -90 && lat <= 90 && lng >= -180 && lng <= 180) {
                    input.style.borderColor = '';
                    placeMarker(lng, lat);
                    return;
                  }
                }
                // Если координаты некорректные — подсвечиваем красным
                input.style.borderColor = '#f44336';
                if (marker) {
                  map.removeLayer(marker);
                  marker = null;
                }
              });

              // При загрузке страницы проверяем, есть ли уже координаты
              if (input.value.trim()) {
                input.dispatchEvent(new Event('change'));
              }
            };
          </script>

        </div>
      </div>
      <div>
        <div
          style="
            /*margin: 0 1rem 1rem 1rem;*/
            border: solid 4px silver;
            border-top: none;
          "
        >
          <!-- <img src="https://iconape.com/wp-content/files/wm/352809/svg/352809.svg" /> -->
          <div style="width: 600px; height: 28px" class="logo 2006">
            <style>
              .logo.\32 006 {
                background: url(windowsxp.svg) no-repeat 0px -0px / auto;
              }
              .logo.\32 006:hover {
                background-position: 0px -29px;
              }
              .ahover.\32 006:hover {
                background: url(windowsxp.svg) no-repeat 0px -116px / 100% 500%;
              }
              /*.logo.\32 006 { background: url(https://i.logos-download.com/113818/28926-ccc6931322fd89aa211fdc698cb3cfae.svg/Windows_Live_Search_Logo.svg) no-repeat 0px 0px / cover; }*/
              /*.logo.\31 995 { background: url(https://iconape.com/wp-content/files/wm/352809/svg/352809.svg) no-repeat 0px 0px / contain; }*/
            </style>
            <span> 1:5 </span>
          </div>
          <div>
            <select onchange="rotate(this.value)">
              <option value="0">Поворот 0°</option>
              <option value="45">Поворот 45°</option>
              <option value="90">Поворот 90°</option>
              <option value="135">Поворот 135°</option>
              <option value="180">Поворот 180°</option>
              <option value="225">Поворот 225°</option>
              <option value="270">Поворот 270°</option>
              <option value="315">Поворот 315°</option>
            </select>
            <label>Ширина <input type="range" /></label>
            <label>Высота <input type="range" /></label>
            <span>Валидный QR</span>
          </div>
          <div style="display: flex; align-items: start">
            <svg
              xmlns:svg="http://www.w3.org/2000/svg"
              shape-rendering="crispEdges"
              viewBox="0 0 2 11"
              style="width: 48px"
            >
              <defs>
                <style id="styleFront">
                  .front {
                    fill: #222;
                  }
                </style>
                <style id="styleBack">
                  .back {
                    fill: #ddd;
                  }
                </style>
                <style>
                  /*svg { stroke: gray; stroke-width: 0.1rem; }*/
                  /*.front { fill: #222; }*/
                  #tools use {
                    stroke: gray;
                    stroke-width: 0.001rem;
                  }
                  #tools g:hover > use:not(.front) {
                    stroke: gray;
                    stroke-width: 0.01rem;
                  }
                  #tools g.active-brush > use:not(.front) {
                    stroke: gray;
                    stroke-width: 0.01rem;
                  }
                  #tools g:nth-child(odd) {
                    --col-x: 0px;
                  }
                  #tools g:nth-child(even) {
                    --col-x: 1px;
                  }
                </style>
                <script>
                  window.ruleF = styleFront.sheet.cssRules[0].style;
                  window.ruleB = styleBack.sheet.cssRules[0].style;

                  function activateBrush(newBrush) {
                    let oldBrush = document.querySelector(".active-brush");
                    oldBrush.classList.remove("active-brush");
                    newBrush.classList.add("active-brush");
                  }
                  window.addEventListener("DOMContentLoaded", () => {
                    // applyAttribs(coon, attribs, 'WhatsApp');
                    document.getElementById("colorFront").value =
                      "#" +
                      ruleF.fill
                        .match(/\d+/g)
                        .map((x) => (+x).toString(16).padStart(2, 0))
                        .join("");
                    document.getElementById("colorBack").value =
                      "#" +
                      ruleB.fill
                        .match(/\d+/g)
                        .map((x) => (+x).toString(16).padStart(2, 0))
                        .join("");
                    regenQR();
                  });

                  function inverse_colors() {
                    let tmp = ruleF.fill;
                    ruleF.fill = ruleB.fill;
                    ruleB.fill = tmp;
                    contrastRatio(ruleF.fill, ruleB.fill);
                  }
                </script>
                <pattern
                  id="checker"
                  width="1"
                  height="1"
                  patternUnits="userSpaceOnUse"
                >
                  <rect width="1" height="1" fill="#fff" />
                  <rect width="0.5" height="0.5" fill="#ccc" />
                  <rect x="0.5" y="0.5" width="0.5" height="0.5" fill="#ccc" />
                </pattern>
                <rect
                  id="rect-checker"
                  fill="url(#checker)"
                  width="1"
                  height="2"
                />
              </defs>
              <g id="tools">
                <g class="brushs">
                  <g
                    style="transform: translate(var(--col-x), 0px)"
                    onclick="activateBrush(this)"
                    class="active-brush"
                  >
                    <use href="#TRBL" class="back" />
                  </g>
                  <g
                    style="transform: translate(var(--col-x), 0px)"
                    onclick="activateBrush(this)"
                  >
                    <use href="#TRBL" class="back" />
                    <use href="#____" class="front" />
                  </g>
                  <g
                    style="transform: translate(var(--col-x), 1px)"
                    onclick="activateBrush(this)"
                  >
                    <use href="#TRBL" class="back" />
                    <use href="#_RB_" class="front" />
                  </g>
                  <g
                    style="transform: translate(var(--col-x), 1px)"
                    onclick="activateBrush(this)"
                  >
                    <use href="#TRBL" class="back" />
                    <use href="#__BL" class="front" />
                  </g>
                  <g
                    style="transform: translate(var(--col-x), 2px)"
                    onclick="activateBrush(this)"
                  >
                    <use href="#TRBL" class="back" />
                    <use href="#TR__" class="front" />
                  </g>
                  <g
                    style="transform: translate(var(--col-x), 2px)"
                    onclick="activateBrush(this)"
                  >
                    <use href="#TRBL" class="back" />
                    <use href="#T__L" class="front" />
                  </g>

                  <g
                    style="transform: translate(var(--col-x), 3px)"
                    onclick="activateBrush(this)"
                  >
                    <use href="#TRBL" class="back" />
                    <use href="#T___" class="front" />
                  </g>

                  <g
                    style="transform: translate(var(--col-x), 3px)"
                    onclick="activateBrush(this)"
                  >
                    <use href="#TRBL" class="back" />
                    <use href="#_R__" class="front" />
                  </g>

                  <g
                    style="transform: translate(var(--col-x), 4px)"
                    onclick="activateBrush(this)"
                  >
                    <use href="#TRBL" class="back" />
                    <use href="#___L" class="front" />
                  </g>
                  <g
                    style="transform: translate(var(--col-x), 4px)"
                    onclick="activateBrush(this)"
                  >
                    <use href="#TRBL" class="back" />
                    <use href="#__B_" class="front" />
                  </g>
                  <g
                    style="transform: translate(var(--col-x), 5px)"
                    onclick="activateBrush(this)"
                  >
                    <use href="#TRBL" class="back" />
                  </g>
                  <g
                    style="transform: translate(var(--col-x), 5px)"
                    onclick="activateBrush(this)"
                  >
                    <use href="#TRBL" class="back" />
                  </g>
                  <g
                    style="transform: translate(var(--col-x), 6px)"
                    onclick="activateBrush(this)"
                  >
                    <use href="#TRBL" class="back" />
                  </g>
                  <g
                    style="transform: translate(var(--col-x), 6px)"
                    onclick="activateBrush(this)"
                  >
                    <use href="#TRBL" class="back" />
                  </g>
                  <!--               <g style="transform: translate(var(--col-x), 6px);" onclick="activateBrush(this)">
                <use href="#TRBL" class="front" />
                <use href="#____" fill="#555" class="back" />
              </g>
              <g style="transform: translate(var(--col-x), 6px);" onclick="activateBrush(this)">
                <use href="#TRBL" class="back" />
                <use href="#____" fill="#555" class="front" />
              </g> -->
                </g>
                <text
                  id="contrast"
                  x="50%"
                  y="8.6"
                  dominant-baseline="middle"
                  text-anchor="middle"
                  font-size="0.8px"
                  onclick="inverse_colors()"
                >
                  5:1
                </text>
                <g>
                  <g style="transform: translate(var(--col-x), 9px)">
                    <use href="#rect-checker" onclick="ruleB.fill='#0000'" />
                  </g>
                  <g style="transform: translate(var(--col-x), 9px)">
                    <use href="#rect-checker" onclick="ruleF.fill='#0000'" />
                  </g>
                  <g style="transform: translate(var(--col-x), 9px)">
                    <use
                      href="#TRBL"
                      class="back"
                      onclick="colorBack.click()"
                    />
                  </g>
                  <g style="transform: translate(var(--col-x), 9px)">
                    <use
                      href="#TRBL"
                      class="front"
                      onclick="colorFront.click()"
                    />
                  </g>
                  <g>
                    <foreignObject>
                      <input
                        id="colorFront"
                        type="color"
                        xmlns="http://www.w3.org/1999/xhtml"
                        oninput="ruleF.fill=event.target.value"
                        onchange="contrastRatio(ruleF.fill, ruleB.fill)"
                      />
                      <input
                        id="colorBack"
                        type="color"
                        xmlns="http://www.w3.org/1999/xhtml"
                        oninput="ruleB.fill=event.target.value"
                        onchange="contrastRatio(ruleF.fill, ruleB.fill)"
                      />
                    </foreignObject>
                  </g>
                </g>
              </g>
            </svg>

            <div>
              <!--           <svg id="back-checker" xmlns:svg="http://www.w3.org/2000/svg" viewBox="0 0 21 21" style="width: 400px; height: 400px;">
            <rect style="width: 21px; height: 21px;" fill="url(#checker)" />
           </svg> -->
              <svg
                id="render"
                class="checker-css"
                xmlns:svg="http://www.w3.org/2000/svg"
                shape-rendering="crispEdges"
                preserveAspectRatio="none"
                style="
                  width: 400px;
                  height: 400px;
                  cursor:
                    url(https://jspaint.app/images/cursors/fill-bucket.png) 5 18,
                    pointer;
                "
              >
                <defs class="tmp">
                  <style>
                    #render-group use:hover {
                      stroke: gray;
                      stroke-width: 0.01rem;
                    }
                    .checker-css {
                      background-color: #fff;
                      background-image:
                        linear-gradient(
                          45deg,
                          #ccc 25%,
                          transparent 25%,
                          transparent 75%,
                          #ccc 75%,
                          #ccc
                        ),
                        linear-gradient(
                          45deg,
                          #ccc 25%,
                          transparent 25%,
                          transparent 75%,
                          #ccc 75%,
                          #ccc
                        );
                      background-size: 16px 16px;
                      background-position:
                        0 0,
                        8px 8px;
                    }
                  </style>
                  <script>
                    function onclk(el) {
                      const activeBrush =
                        document.querySelector(".active-brush");
                      const nodes = Array.from(activeBrush.children).map((el) =>
                        el.cloneNode(false),
                      );
                      // nodes[0].removeAttribute('class');
                      // nodes[1].removeAttribute('class');
                      console.log(nodes[0].className); // SVGAnimatedString {baseVal: 'back', animVal: 'back'}

                      const g = el.parentNode;
                      const colors = [
                        "#" +
                          ruleB.fill
                            .match(/\d+/g)
                            .map((x) => (+x).toString(16).padStart(2, 0))
                            .join(""),
                        "#" +
                          ruleF.fill
                            .match(/\d+/g)
                            .map((x) => (+x).toString(16).padStart(2, 0))
                            .join(""),
                      ];
                      const svg = document.querySelector("#render");
                      const xmlns = svg.getAttribute("xmlns:svg");
                      // console.log(nodes)
                      nodes.forEach((use) => {
                        // if (use)
                        {
                          use.setAttribute("x", el.getAttribute("x"));
                          use.setAttribute("y", el.getAttribute("y"));
                          use.setAttribute(
                            "fill",
                            use.classList.contains("front")
                              ? colors[1]
                              : colors[0],
                          );
                          use.removeAttribute("class");
                          use.addEventListener("click", () => onclk(use));
                        }
                      });
                      // use1.setAttribute('href', '#TRBL');
                      g.replaceChildren(...nodes);
                      // const colors=[...document.querySelector('#colors').children].map(r => `#${r.id}`);
                      // const i=colors.indexOf(el.getAttribute('href'));
                      // el.setAttribute('href', colors[(i+1)%colors.length]);
                    }
                  </script>
                </defs>
                <defs>
                  <g id="brushs">
                    <rect id="TRBL" width="1" height="1" />
                    <circle id="____" r="0.45" cx="0.5" cy="0.5" />
                    <path id="__BL" d="M0 1 L0 0 A1 1 0 0 1 1 1 Z" />
                    <path id="T__L" d="M0 0 L1 0 A1 1 0 0 1 0 1 Z" />
                    <path id="TR__" d="M1 0 L1 1 A1 1 0 0 1 0 0 Z" />
                    <path id="_RB_" d="M1 1 L0 1 A1 1 0 0 1 1 0 Z" />
                    <path id="__B_" d="M1 1 0 1 0 0.5 A0.5 0.5 0 1 1 1 0.5 Z" />
                    <path
                      id="___L"
                      d="M0 1 L0 0 0.5 0 A0.5 0.5 0 1 1 0.5 1 Z"
                    />
                    <path
                      id="T___"
                      d="M0 0 L1 0 1 0.5 A0.5 0.5 0 0 1 0 0.5 Z"
                    />
                    <path id="_R__" d="M1 0 1 1 0.5 1 A0.5 0.5 0 1 1 0.5 0 Z" />
                  </g>
                </defs>
                <g id="render-group" fill="red"></g>
              </svg>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!--  <input id="tgLink" value="https://t.me/+" placeholder="0123456789"
       oninput="this.value='https://t.me/+'+this.value.slice(14)"> -->
  </body>
</html>
